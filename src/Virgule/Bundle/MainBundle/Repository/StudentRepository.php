<?php

namespace Virgule\Bundle\MainBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\NoResultException;
use Doctrine\ORM\Query;

/**
 * StudentRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class StudentRepository extends EntityRepository {
    
    /**
     * Select all students enrolled in a class of the selected semester
     * @return type
     */
    public function loadAll($semesterId) {
        $q = $this
            ->createQueryBuilder('s')
            ->addSelect('s.id, s.firstname, s.lastname, s.gender, s.phoneNumber, s.cellphoneNumber, s.registrationDate, t.id as teacher_id, t.firstName as teacher_firstName, t.lastName as teacher_lastName')
            ->addSelect('c.isoCode, c.label')
            ->innerJoin('s.nativeCountry', 'c')
            ->innerJoin('s.courses', 'c2')
            ->leftJoin('s.welcomedByTeacher', 't')
            ->where('c2.semester = :semesterId')
            ->add('orderBy', 's.lastname ASC')
            ->setParameter('semesterId', $semesterId)
            ->getQuery()
        ;
        $students = $q->execute(array(), Query::HYDRATE_ARRAY);
        return $students;   
    }
    
         public function loadAllClassSessionByTeacher($semesterId, $teacherId, $limit=5) {
        $q = $this
            ->createQueryBuilder('c')
            ->addSelect('c.id, c.date, count(cm.id) as nb_comments')
            ->innerJoin('c.sessionTeacher', 't', 'WITH', 't.id = :teacherId')
            ->leftJoin('c.comments', 'cm')
            ->setParameter('teacherId', $teacherId)
            ->setMaxResults($limit) 
            ->add('orderBy', 'c.date DESC')
            ->add('groupBy', 'c.id')
            ->getQuery()
        ;
        $results = $q->execute(array(), Query::HYDRATE_ARRAY);
        return $results;   
    }
    
    public function loadAllEnrolledInCourses(Array $courseIds) {
        $ids = implode(',',$courseIds);
        $q = $this
            ->createQueryBuilder('s')
            ->addSelect('s.id, s.firstname as firstname, s.lastname as lastname, s.gender as gender, s.phoneNumber as phoneNumber, s.cellphoneNumber, count(cm.id) as nb_comments')
            ->addSelect('c.isoCode, c.label')
            ->innerJoin('s.nativeCountry', 'c')
            ->innerJoin('s.courses', 'c2', 'WITH', 'c2.id IN (:coursesIds)')
            ->leftJoin('s.comments', 'cm')
            ->add('orderBy', 's.lastname ASC')
            ->add('groupBy', 's.id')
            ->setParameter('coursesIds', $ids)
            ->getQuery()
        ;
        $students = $q->execute(array(), Query::HYDRATE_ARRAY);
        return $students;   
    }
    
    /**
     * 
     * @param array $courseIds
     * @return type
     */
    public function loadAllEnrolledInCourse($courseId) {
        return $this->loadAllEnrolledInCourses(Array($courseId));
    }
}
